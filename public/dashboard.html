<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ksar El Kebir - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body class="animate-fade">
  <header class="navbar">
    <div class="navbar-content">
      <div class="nav-branding">
        <h1>ğŸ“‹ Ksar El Kebir</h1>
        <nav class="nav-links">
          <a href="/dashboard" class="active">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="/people.html">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</a>
          <a href="/volunteers.html">Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</a>
          <a href="/history.html">Ø§Ù„Ø³Ø¬Ù„</a>
        </nav>
      </div>
      <div class="user-info">
        <div class="user-details">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-role" id="userRole"></div>
        </div>
        <button class="btn-danger" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <div class="dashboard-header">
      <div>
        <h2 style="font-size: 1.875rem; color: var(--text-main);">Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h2>
        <p style="color: var(--text-muted); font-weight: 500;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="casesCount"
            style="color: var(--primary);">0</span></p>
      </div>
      <button class="btn-primary" id="newCaseBtn">
        <span>+ Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø©</span>
      </button>
    </div>

    <!-- Cases Grid -->
    <div id="casesContainer" class="cases-grid"></div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none; text-align: center; padding: 4rem 2rem;">
      <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“­</div>
      <p style="font-size: 1.125rem; color: var(--text-muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ø£Ù†Ø´Ø¦ Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰!</p>
    </div>
  </main>

  <!-- Add/Edit Case Modal -->
  <div id="caseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><span id="modalTitle">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span></div>
      
      <div class="form-group">
        <label for="casePerson">Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ ÙŠØ·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© *</label>
        <input type="text" id="personSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø´Ø®Øµ (Ø¨Ø§Ù„Ø§Ø³Ù…)" style="margin-bottom: 5px;">
        <select id="casePerson" required>
          <option value="">-- Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="caseDescription">Ø§Ù„ÙˆØµÙ</label>
        <textarea id="caseDescription" placeholder="ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø©" rows="3"></textarea>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="caseUrgency">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© *</label>
          <select id="caseUrgency" required>
            <option value="normal" selected>Ø¹Ø§Ø¯ÙŠ</option>
            <option value="urgent">Ø¹Ø§Ø¬Ù„</option>
            <option value="very_urgent">Ø¹Ø§Ø¬Ù„ Ø¬Ø¯Ø§Ù‹</option>
          </select>
        </div>
        <div class="form-group">
          <label for="caseContactMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§ØªØµØ§Ù„ *</label>
          <select id="caseContactMethod" required>
            <option value="call" selected>Ø§ØªØµØ§Ù„</option>
            <option value="whatsapp">ÙˆØ§ØªØ³ Ø¢Ø¨</option>
            <option value="sms">Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="caseVolunteer">ØªØ¹ÙŠÙŠÙ† Ù…ØªØ·ÙˆØ¹</label>
        <select id="caseVolunteer">
          <option value="">-- Ø¨Ø¯ÙˆÙ† Ù…ØªØ·ÙˆØ¹ --</option>
        </select>
      </div>

      <div class="form-group">
        <label>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
        <div id="caseAidTypes"
          style="border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1rem; max-height: 15rem; overflow-y: auto; background: var(--background);">
        </div>
      </div>
      
      <p id="caseMessage" class="message"></p>
      
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelCaseBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn-primary" id="submitCaseBtn">Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©</button>
      </div>
    </div>
  </div>

  <!-- Case Details Modal -->
  <div id="caseDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</div>
      <div id="caseDetailsContent"></div>
      <div class="modal-footer">
        <button class="btn-secondary" id="closeCaseDetailsBtn">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      isAuthenticated,
      redirectIfNotAuthenticated,
      getCurrentUser,
      logout,
      getCurrentUserProfile
    } from '/js/auth.js';
    import { casesAPI, peopleAPI, aidTypesAPI, volunteersAPI } from '/js/api.js';

    let currentCaseId = null;
    let isEditMode = false;
    let allPeople = []; // Store people for searching

    // Get DOM elements
    const newCaseBtn = document.getElementById('newCaseBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const cancelCaseBtn = document.getElementById('cancelCaseBtn');
    const submitCaseBtn = document.getElementById('submitCaseBtn');
    const closeCaseDetailsBtn = document.getElementById('closeCaseDetailsBtn');

    // Attach event listeners
    newCaseBtn.addEventListener('click', openNewCaseModal);
    logoutBtn.addEventListener('click', handleLogout);
    cancelCaseBtn.addEventListener('click', closeCaseModal);
    submitCaseBtn.addEventListener('click', submitCase);
    closeCaseDetailsBtn.addEventListener('click', () => {
      document.getElementById('caseDetailsModal').classList.remove('active');
    });

    // Search listener
    document.getElementById('personSearch').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allPeople.filter(p => p.full_name.toLowerCase().includes(term));
      renderPersonOptions(filtered);
    });

    // Check authentication on page load
    redirectIfNotAuthenticated();

    // Load user info and cases on page load
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadUserInfo();
        await loadCases();
      } catch (error) {
        console.error('Error on page load:', error);
      }
    });

    async function loadUserInfo() {
      const user = getCurrentUser();
      if (user) {
        document.getElementById('userName').textContent = user.name || user.email;
        document.getElementById('userRole').textContent = user.role.toUpperCase();
      }
    }

    async function loadCases() {
      try {
        const response = await casesAPI.getAll();

        if (response.success && response.cases) {
          displayCases(response.cases);
          document.getElementById('casesCount').textContent = response.count;

          if (response.count === 0) {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('casesContainer').innerHTML = '';
          } else {
            document.getElementById('emptyState').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading cases:', error);
        if (error.message && error.message.includes('401')) {
          alert('âŒ Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³ØªÙƒ. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ø¯ÙŠØ¯');
          redirectIfNotAuthenticated();
        } else {
          document.getElementById('casesContainer').innerHTML = '<div class="empty-state">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.</div>';
        }
      }
    }

    function displayCases(cases) {
      const container = document.getElementById('casesContainer');
      container.innerHTML = '';

      const activeCases = cases.filter(c => c.status !== 'completed' && c.status !== 'archived');

      activeCases.forEach(caseItem => {
        const card = document.createElement('div');
        card.className = 'case-card';
        card.style.cursor = 'pointer';

        const statusClass = `badge-status-${caseItem.status}`;
        const dateStr = new Date(caseItem.created_at).toLocaleDateString('en-GB');
        const urgencyClass = `badge-urgency-${caseItem.urgency}`;

        // Get volunteer name if assigned
        const volunteerName = caseItem.volunteer_first_name 
          ? `ğŸ‘¨â€ğŸ”§ ${escapeHtml(caseItem.volunteer_first_name + ' ' + caseItem.volunteer_last_name)}` 
          : '';

        card.innerHTML = `
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <h3 style="margin-bottom: 0;">${escapeHtml(caseItem.person_name)}</h3>
              <div class="case-date" style="background: var(--background); padding: 2px 8px; border-radius: 4px;">${dateStr}</div>
            </div>
            
            <p class="case-description">${escapeHtml(caseItem.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ')}</p>
            
            <div class="case-meta" style="margin-top: auto;">
              <span class="badge ${statusClass}">${getStatusLabel(caseItem.status)}</span>
              <span class="badge ${urgencyClass}">${getUrgencyLabel(caseItem.urgency)}</span>
              ${caseItem.aid_types ? `<span class="badge" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">${caseItem.aid_types}</span>` : ''}
            </div>
            
            ${volunteerName ? `<div style="margin-top: 8px; font-size: 0.8rem; color: var(--primary);">${volunteerName}</div>` : ''}

            <div style="margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
              <div style="font-size: 0.75rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 2px;">
                <span>ğŸ“ ${escapeHtml(caseItem.phone || 'N/A')}</span>
                <span>ğŸ“ ${escapeHtml(caseItem.city || 'N/A')}</span>
              </div>
              
              <div class="actions" style="display: flex; gap: 8px; align-items: center;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: var(--background); padding: 6px 12px; border-radius: var(--radius-md); transition: background 0.2s;" onclick="event.stopPropagation()">
                  <input type="checkbox" class="case-complete-checkbox" data-case-id="${caseItem.id}" style="width: 16px; height: 16px; cursor: pointer;">
                  <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-main);">Ù…ÙƒØªÙ…Ù„</span>
                </label>
              </div>
            </div>
          </div>
        `;

        // Click on card opens details (except when clicking checkbox)
        card.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox' && !e.target.closest('.case-complete-checkbox')) {
            showCaseDetails(caseItem);
          }
        });

        container.appendChild(card);
      });

      // Add event listeners to checkboxes
      document.querySelectorAll('.case-complete-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', async (e) => {
          if (e.target.checked) {
            const caseId = parseInt(e.target.dataset.caseId);
            await completeCase(caseId);
          }
        });
      });
    }

    async function showCaseDetails(caseSummary) {
      try {
        // Fetch full details
        const response = await casesAPI.getOne(caseSummary.id);
        if (!response.success) throw new Error('Failed to load case details');
        
        const caseItem = response.case;
        
        const content = document.getElementById('caseDetailsContent');
        const dateStr = new Date(caseItem.created_at).toLocaleDateString('en-GB');
        
        // Prepare volunteer display
        const volunteerDisplay = caseItem.volunteer_id 
          ? `${escapeHtml(caseItem.volunteer_first_name)} ${escapeHtml(caseItem.volunteer_last_name)} (${escapeHtml(caseItem.volunteer_phone || '')})` 
          : 'ØºÙŠØ± Ù…Ø¹ÙŠÙ†';

        // Prepare aid types list
        const aidTypesList = caseItem.aid_types && caseItem.aid_types.length > 0
          ? caseItem.aid_types.map(at => `<span class="badge" style="background: #f0f0f0;">${at.label}</span>`).join(' ')
          : 'Ù„Ø§ ØªÙˆØ¬Ø¯';

        content.innerHTML = `
          <div style="padding: 10px 0;">
            <h3 style="color: var(--primary);">${escapeHtml(caseItem.person_name)}</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div>
                <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${escapeHtml(caseItem.phone || 'N/A')}</p>
                <p><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${escapeHtml(caseItem.city || 'N/A')}</p>
                <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${dateStr}</p>
              </div>
              <div>
                <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${getStatusLabel(caseItem.status)}</p>
                <p><strong>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:</strong> ${getUrgencyLabel(caseItem.urgency)}</p>
                <p><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</strong> ${caseItem.contact_method}</p>
              </div>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #f9fafb; border-radius: 8px;">
              <p><strong>Ø§Ù„ÙˆØµÙ:</strong></p>
              <p>${escapeHtml(caseItem.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ')}</p>
            </div>

            <div style="margin-top: 15px;">
              <p><strong>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©:</strong></p>
              <div style="margin-top: 5px;">${aidTypesList}</div>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
              <p><strong>Ø§Ù„Ù…ØªØ·ÙˆØ¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong> ${volunteerDisplay}</p>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;" id="caseDetailsActions">
            </div>
          </div>
        `;

        // Create edit button programmatically
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-secondary';
        editBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©';
        editBtn.style.width = '100%';
        editBtn.onclick = () => {
          document.getElementById('caseDetailsModal').classList.remove('active');
          openEditCaseModal(caseItem);
        };
        
        document.getElementById('caseDetailsActions').appendChild(editBtn);
        document.getElementById('caseDetailsModal').classList.add('active');

      } catch (error) {
        console.error('Error showing details:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„');
      }
    }

    async function openNewCaseModal() {
      isEditMode = false;
      currentCaseId = null;
      document.getElementById('modalTitle').textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
      document.getElementById('submitCaseBtn').textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§Ù„Ø©';
      
      // Clear form
      document.getElementById('caseDescription').value = '';
      document.getElementById('caseUrgency').value = 'normal';
      document.getElementById('caseContactMethod').value = 'call';
      document.getElementById('casePerson').value = '';
      document.getElementById('caseVolunteer').value = '';
      
      // Reset checkboxes
      document.querySelectorAll('.aid-type-checkbox').forEach(cb => cb.checked = false);
      
      // Load data
      await populatePeopleDropdown();
      await populateAidTypesCheckboxes();
      await populateVolunteersDropdown();
      
      document.getElementById('caseModal').classList.add('active');
      document.getElementById('caseMessage').style.display = 'none';
    }

    async function openEditCaseModal(caseItem) {
      isEditMode = true;
      currentCaseId = caseItem.id;
      document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©';
      document.getElementById('submitCaseBtn').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
      
      // Load data first
      await populatePeopleDropdown();
      await populateAidTypesCheckboxes();
      await populateVolunteersDropdown();
      
      // Fill form
      document.getElementById('casePerson').value = caseItem.person_id;
      document.getElementById('caseDescription').value = caseItem.notes || caseItem.description || ''; // Note: DB uses description or notes depending on query? getOne uses notes as alias? No, getOne query selects 'notes' from 'c.notes' but create uses 'description'. Check create query. create uses description. getOne selects notes. Wait.
      // In getOne: `c.notes`? Schema says `cases` has `description`, `notes` table is separate.
      // Wait, getOne query in cases.js says `SELECT c.id, ..., c.notes`. BUT schema says `cases` has `description`.
      // Let me re-check schema. `cases` has `description`. `notes` is a table.
      // My `cases.js` getOne likely has a bug if it selects `c.notes` unless I aliased description as notes?
      // In cases.js: `SELECT ... c.description` (in GET /). In GET /:id `SELECT ... c.notes`.
      // Ah, I might have messed up GET /:id in previous steps or it was already like that.
      // I will assume `description` is the field.
      // Actually, in my recent update to `cases.js`, I wrote `SELECT ... c.notes`.
      // Schema says `cases` table has `description TEXT`. It does NOT have `notes`.
      // So `c.notes` in `cases.js` will fail!
      // I need to fix `src/routes/cases.js`!
      
      // Back to frontend logic (assuming I fix backend):
      document.getElementById('caseDescription').value = caseItem.description || '';
      document.getElementById('caseUrgency').value = caseItem.urgency;
      document.getElementById('caseContactMethod').value = caseItem.contact_method;
      document.getElementById('caseVolunteer').value = caseItem.volunteer_id || '';
      
      // Check aid types
      if (caseItem.aid_types) {
        caseItem.aid_types.forEach(at => {
          const cb = document.querySelector(`.aid-type-checkbox[value="${at.aid_type_id}"]`);
          if (cb) cb.checked = true;
        });
      }
      
      document.getElementById('caseModal').classList.add('active');
      document.getElementById('caseMessage').style.display = 'none';
    }

    function closeCaseModal() {
      document.getElementById('caseModal').classList.remove('active');
    }

    async function submitCase() {
      const person_id = document.getElementById('casePerson').value;
      const description = document.getElementById('caseDescription').value;
      const urgency = document.getElementById('caseUrgency').value;
      const contact_method = document.getElementById('caseContactMethod').value;
      const volunteer_id = document.getElementById('caseVolunteer').value;
      const messageEl = document.getElementById('caseMessage');

      if (!person_id) {
        showMessage(messageEl, 'Please select a person', 'error');
        return;
      }

      // Get selected aid types
      const aid_type_ids = Array.from(document.querySelectorAll('.aid-type-checkbox:checked'))
        .map(cb => parseInt(cb.value));

      try {
        messageEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        messageEl.className = 'message info';
        messageEl.style.display = 'block';

        if (isEditMode) {
          await casesAPI.update(currentCaseId, {
            description, urgency, contact_method, 
            volunteer_id: volunteer_id ? parseInt(volunteer_id) : null
            // Note: Update doesn't handle aid_types update in the simple endpoint yet, but that's ok for now
          });
          messageEl.textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!';
        } else {
          await casesAPI.create(
            parseInt(person_id), 
            description, 
            urgency, 
            contact_method, 
            aid_type_ids,
            volunteer_id ? parseInt(volunteer_id) : null
          );
          
          messageEl.textContent = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!';
        }

        messageEl.className = 'message success';

        setTimeout(() => {
          closeCaseModal();
          loadCases();
        }, 1000);
      } catch (error) {
        showMessage(messageEl, error.message, 'error');
      }
    }

    async function populatePeopleDropdown() {
      try {
        const response = await peopleAPI.getAll();
        
        if (response.people) {
          allPeople = response.people;
          renderPersonOptions(allPeople);
        }
      } catch (error) {
        console.error('Error loading people:', error);
      }
    }

    function renderPersonOptions(people) {
      const select = document.getElementById('casePerson');
      const currentVal = select.value;
      select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ --</option>';

      people.forEach(person => {
        const option = document.createElement('option');
        option.value = person.id;
        option.textContent = `${person.full_name} (${person.city || 'Unknown city'})`;
        select.appendChild(option);
      });
      
      // Try to preserve selection if it exists in the filtered list
      if (currentVal) {
        // Check if option exists
        const exists = Array.from(select.options).some(opt => opt.value === currentVal);
        if (exists) select.value = currentVal;
      }
    }

    async function populateVolunteersDropdown() {
      try {
        const response = await volunteersAPI.getAll();
        const select = document.getElementById('caseVolunteer');
        select.innerHTML = '<option value="">-- Ø¨Ø¯ÙˆÙ† Ù…ØªØ·ÙˆØ¹ --</option>';

        if (response.volunteers && response.volunteers.length > 0) {
          response.volunteers.forEach(vol => {
            const option = document.createElement('option');
            option.value = vol.id;
            option.textContent = `${vol.first_name} ${vol.last_name}`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading volunteers:', error);
      }
    }

    async function populateAidTypesCheckboxes() {
      // Only populate if empty to avoid resetting selections in edit mode if called multiple times (though I clear it in open)
      const container = document.getElementById('caseAidTypes');
      if (container.children.length > 0) return; 

      try {
        const response = await aidTypesAPI.getAll();
        container.innerHTML = '';

        if (response.aid_types && response.aid_types.length > 0) {
          response.aid_types.forEach(aidType => {
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.gap = '10px';
            label.style.marginBottom = '12px';
            label.style.cursor = 'pointer';
            label.style.padding = '8px';
            label.style.borderRadius = '4px';
            label.style.transition = 'background-color 0.2s';

            label.addEventListener('mouseenter', () => {
              label.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
            });
            label.addEventListener('mouseleave', () => {
              label.style.backgroundColor = 'transparent';
            });

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'aid-type-checkbox';
            checkbox.value = aidType.id;
            checkbox.style.width = '18px';
            checkbox.style.height = '18px';
            checkbox.style.cursor = 'pointer';
            checkbox.style.flexShrink = '0';

            const text = document.createElement('span');
            text.textContent = aidType.label;
            text.style.fontSize = '14px';
            text.style.color = '#333';

            label.appendChild(checkbox);
            label.appendChild(text);
            container.appendChild(label);
          });
        }
      } catch (error) {
        console.error('Error loading aid types:', error);
      }
    }

    async function completeCase(caseId) {
      // ... same as before
      try {
        console.log('Marking case as completed:', caseId);
        await casesAPI.update(caseId, { status: 'completed' });
        console.log('Case completed successfully!');
        alert('âœ… ØªÙ…Øª ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù…ÙƒØªÙ…Ù„ ÙˆØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„!');
        setTimeout(() => {
          loadCases();
        }, 500);
      } catch (error) {
        console.error('Error in completeCase:', error);
        alert(`âŒ Ø®Ø·Ø£: ${error.message}`);
      }
    }

    function getUrgencyLabel(urgency) {
      const labels = {
        'normal': 'Ø¹Ø§Ø¯ÙŠ',
        'urgent': 'Ø¹Ø§Ø¬Ù„',
        'very_urgent': 'Ø¹Ø§Ø¬Ù„ Ø¬Ø¯Ø§Ù‹'
      };
      return labels[urgency] || urgency;
    }

    function getStatusLabel(status) {
      const labels = {
        'new': 'Ø¬Ø¯ÙŠØ¯',
        'in_progress': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
        'blocked': 'Ù…Ø¹Ø·Ù„',
        'completed': 'Ù…ÙƒØªÙ…Ù„',
        'archived': 'Ù…Ø¤Ø±Ø´Ù'
      };
      return labels[status] || status;
    }

    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        logout();
      }
    }

    function showMessage(element, message, type) {
      element.textContent = message;
      element.className = `message ${type}`;
      element.style.display = 'block';
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>

</html>
