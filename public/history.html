<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ø³Ø¬Ù„ - Ksar El Kebir</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body {
      direction: rtl;
      text-align: right;
    }

    .history-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .filter-select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
    }

    .case-card.completed {
      opacity: 0.7;
      border-right: 4px solid #4caf50;
    }

    .archive-btn {
      background-color: #ff9800;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.3s;
    }

    .archive-btn:hover {
      background-color: #f57c00;
    }

    .restore-btn {
      background-color: #2196f3;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.3s;
    }

    .restore-btn:hover {
      background-color: #1976d2;
    }
  </style>
</head>

<body class="animate-fade">
  <!-- Navbar -->
  <header class="navbar">
    <div class="navbar-content">
      <div class="nav-branding">
        <h1>ğŸ“‹ Ksar El Kebir</h1>
        <nav class="nav-links">
          <a href="/dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="/people.html">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</a>
          <a href="/history.html" class="active">Ø§Ù„Ø³Ø¬Ù„</a>
        </nav>
      </div>
      <div class="user-info">
        <div class="user-details">
          <div class="user-name" id="userName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          <div class="user-role" id="userRole"></div>
        </div>
        <button class="btn-danger" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <div class="dashboard-header">
      <div>
        <h2 style="font-size: 1.875rem; color: var(--text-main);">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¤Ø±Ø´Ù</h2>
        <p style="color: var(--text-muted); font-weight: 500;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="historyCount"
            style="color: var(--primary);">0</span></p>
      </div>
    </div>

    <!-- Filters -->
    <div class="history-filters">
      <select id="statusFilter" class="filter-select">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
        <option value="archived">Ù…Ø¤Ø±Ø´ÙØ©</option>
      </select>
      <select id="urgencyFilter" class="filter-select">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª</option>
        <option value="normal">Ø¹Ø§Ø¯ÙŠ</option>
        <option value="urgent">Ø¹Ø§Ø¬Ù„</option>
        <option value="very_urgent">Ø¹Ø§Ø¬Ù„ Ø¬Ø¯Ø§Ù‹</option>
      </select>
    </div>

    <!-- History Grid -->
    <div id="historyContainer" class="cases-grid"></div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <p>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…Ø¤Ø±Ø´ÙØ©</p>
    </div>
    </div>

    <script type="module">
      import {
        isAuthenticated,
        redirectIfNotAuthenticated,
        getCurrentUser,
        logout,
        getCurrentUserProfile
      } from '/js/auth.js';
      import { casesAPI } from '/js/api.js';

      // Get DOM elements
      const logoutBtn = document.getElementById('logoutBtn');
      const historyContainer = document.getElementById('historyContainer');
      const emptyState = document.getElementById('emptyState');
      const historyCount = document.getElementById('historyCount');
      const statusFilter = document.getElementById('statusFilter');
      const urgencyFilter = document.getElementById('urgencyFilter');

      // Attach event listeners
      logoutBtn.addEventListener('click', handleLogout);
      statusFilter.addEventListener('change', loadHistory);
      urgencyFilter.addEventListener('change', loadHistory);

      // Check authentication on page load
      redirectIfNotAuthenticated();

      // Load user info and history on page load
      document.addEventListener('DOMContentLoaded', async () => {
        await loadUserInfo();
        await loadHistory();
      });

      async function loadUserInfo() {
        try {
          const user = getCurrentUser();
          try {
            const userProfile = await getCurrentUserProfile();
            if (userProfile) {
              document.getElementById('userName').textContent = userProfile.full_name || user.email;
              document.getElementById('userRole').textContent = userProfile.role || 'Ù…Ø³ØªØ®Ø¯Ù…';
            } else {
              document.getElementById('userName').textContent = user.email;
              document.getElementById('userRole').textContent = 'Ù…Ø³ØªØ®Ø¯Ù…';
            }
          } catch (profileError) {
            console.log('Could not load profile, using basic user info');
            document.getElementById('userName').textContent = user.email;
            document.getElementById('userRole').textContent = 'Ù…Ø³ØªØ®Ø¯Ù…';
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
          document.getElementById('userName').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        }
      }

      async function loadHistory() {
        try {
          const data = await casesAPI.getAll();
          let cases = data.cases || data || [];

          // Ensure cases is an array
          if (!Array.isArray(cases)) {
            console.warn('Cases is not an array:', cases);
            cases = [];
          }

          // Filter only completed and archived cases
          cases = cases.filter(c => c.status === 'completed' || c.status === 'archived');

          // Apply filters
          const statusFilterValue = statusFilter.value;
          const urgencyFilterValue = urgencyFilter.value;

          if (statusFilterValue) {
            cases = cases.filter(c => c.status === statusFilterValue);
          }

          if (urgencyFilterValue) {
            cases = cases.filter(c => c.urgency === urgencyFilterValue);
          }

          historyCount.textContent = cases.length;

          if (cases.length === 0) {
            historyContainer.innerHTML = '';
            emptyState.style.display = 'block';
            return;
          }

          emptyState.style.display = 'none';
          historyContainer.innerHTML = cases.map(c => `
          <div class="case-card">
            <div style="display: flex; flex-direction: column; height: 100%;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0;">ğŸ“‹ ${escapeHtml(c.person_name)}</h3>
                <div class="case-date" style="background: var(--background); padding: 2px 8px; border-radius: 4px;">${new Date(c.created_at).toLocaleDateString('ar-SA')}</div>
              </div>
              
              <p class="case-description">${escapeHtml(c.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ')}</p>
              
              <div class="case-meta" style="margin-top: auto;">
                <span class="badge badge-status-${c.status}">${getStatusLabel(c.status)}</span>
                <span class="badge badge-urgency-${c.urgency}">${getUrgencyLabel(c.urgency)}</span>
                ${c.aid_types ? `<span class="badge" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">${c.aid_types}</span>` : ''}
              </div>
              
              <div style="margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 0.75rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 2px;">
                  <span>ğŸ“ ${escapeHtml(c.phone || 'N/A')}</span>
                  <span>ğŸ“ ${escapeHtml(c.city || 'N/A')}</span>
                  <span>ğŸ’¬ ${getContactMethodLabel(c.contact_method)}</span>
                </div>
                <button class="btn-secondary" onclick="restoreCase(${c.id})" style="padding: 4px 12px; font-size: 12px;">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
              </div>
            </div>
          </div>
        `).join('');

        } catch (error) {
          console.error('Ø®Ø·Ø£:', error);
          historyContainer.innerHTML = `<p class="error">Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}</p>`;
        }
      }

      async function handleLogout() {
        logout();
        window.location.href = '/';
      }

      window.restoreCase = async function (caseId) {
        try {
          await casesAPI.update(caseId, { status: 'new' });

          alert('ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          await loadHistory();
        } catch (error) {
          alert(`Ø®Ø·Ø£: ${error.message}`);
        }
      };

      function getUrgencyLabel(urgency) {
        const labels = {
          'normal': 'Ø¹Ø§Ø¯ÙŠ',
          'urgent': 'Ø¹Ø§Ø¬Ù„',
          'very_urgent': 'Ø¹Ø§Ø¬Ù„ Ø¬Ø¯Ø§Ù‹'
        };
        return labels[urgency] || urgency;
      }

      function getStatusLabel(status) {
        const labels = {
          'new': 'Ø¬Ø¯ÙŠØ¯',
          'in_progress': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
          'blocked': 'Ù…Ø¹Ø·Ù„',
          'completed': 'Ù…ÙƒØªÙ…Ù„',
          'archived': 'Ù…Ø¤Ø±Ø´Ù'
        };
        return labels[status] || status;
      }

      function getContactMethodLabel(method) {
        const labels = {
          'call': 'Ø§ØªØµØ§Ù„',
          'whatsapp': 'ÙˆØ§ØªØ³ Ø¢Ø¨',
          'sms': 'Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©'
        };
        return labels[method] || method;
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
</body>

</html>