<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ - Ksar El Kebir</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body {
      direction: rtl;
      text-align: right;
    }
  </style>
</head>

<body class="animate-fade">
  <header class="navbar">
    <div class="navbar-content">
      <div class="nav-branding">
        <h1>ğŸ‘¥ Ksar El Kebir</h1>
        <nav class="nav-links">
          <a href="/dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="/people.html" class="active">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</a>
          <a href="/volunteers.html">Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</a>
          <a href="/history.html">Ø§Ù„Ø³Ø¬Ù„</a>
        </nav>
      </div>
      <div class="user-info">
        <div class="user-details">
          <div class="user-name" id="userName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          <div class="user-role" id="userRole"></div>
        </div>
        <button class="btn-danger" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <div class="dashboard-header">
      <div>
        <h2 style="font-size: 1.875rem; color: var(--text-main);">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</h2>
        <p style="color: var(--text-muted); font-weight: 500;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="peopleCount"
            style="color: var(--primary);">0</span></p>
      </div>
      <button class="btn-primary" id="newPersonBtn">
        <span>+ Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</span>
      </button>
    </div>

    <!-- People List -->
    <div id="peopleContainer" class="cases-grid"></div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <p>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø´Ø®Ø§Øµ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø£Ø¶Ù Ø£ÙˆÙ„ Ø´Ø®Øµ!</p>
    </div>
    </div>

    <!-- Add/Edit Person Modal -->
    <div id="personModal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯</span></div>
        <div class="form-group">
          <label for="personName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
          <input type="text" id="personName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label for="personPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="tel" id="personPhone" placeholder="+966500000000">
          </div>
          <div class="form-group">
            <label for="personCity">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© *</label>
            <input type="text" id="personCity" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" required>
          </div>
        </div>
        <div class="form-group">
          <label for="personNumberOfPeople">Ø¹Ø¯Ø¯ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø±Ø© *</label>
          <input type="number" id="personNumberOfPeople" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label for="personNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
          <textarea id="personNotes" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©" rows="3"></textarea>
        </div>
        <p id="personMessage" class="message"></p>
        <div class="modal-footer">
          <button class="btn-secondary" id="cancelPersonBtn">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn-primary" id="submitPersonBtn">Ø­ÙØ¸ Ø§Ù„Ø´Ø®Øµ</button>
        </div>
      </div>
    </div>

    <!-- Person Details Modal -->
    <div id="personDetailsModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø®Øµ</div>
        <div id="personDetailsContent"></div>
        <div class="modal-footer">
          <button class="btn-danger" id="deletePersonBtn">Ø­Ø°Ù Ø§Ù„Ø´Ø®Øµ</button>
          <button class="btn-secondary" id="closeDetailsBtn">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        isAuthenticated,
        redirectIfNotAuthenticated,
        getCurrentUser,
        logout
      } from '/js/auth.js';
      import { peopleAPI } from '/js/api.js';

      let currentPersonId = null;
      let isEditMode = false;

      // Get DOM elements
      const newPersonBtn = document.getElementById('newPersonBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const cancelPersonBtn = document.getElementById('cancelPersonBtn');
      const submitPersonBtn = document.getElementById('submitPersonBtn');
      const closeDetailsBtn = document.getElementById('closeDetailsBtn');
      const deletePersonBtn = document.getElementById('deletePersonBtn');

      // Attach event listeners
      newPersonBtn.addEventListener('click', openPersonModal);
      logoutBtn.addEventListener('click', handleLogout);
      cancelPersonBtn.addEventListener('click', closePersonModal);
      submitPersonBtn.addEventListener('click', submitPerson);
      closeDetailsBtn.addEventListener('click', closeDetailsModal);
      deletePersonBtn.addEventListener('click', confirmDeletePerson);

      // Check authentication on page load
      redirectIfNotAuthenticated();

      // Load user info and people on page load
      document.addEventListener('DOMContentLoaded', async () => {
        await loadUserInfo();
        await loadPeople();
      });

      async function loadUserInfo() {
        const user = getCurrentUser();
        if (user) {
          document.getElementById('userName').textContent = user.name || user.email;
          document.getElementById('userRole').textContent = user.role.toUpperCase();
        }
      }

      async function loadPeople() {
        try {
          const response = await peopleAPI.getAll();

          if (response.success && response.people) {
            displayPeople(response.people);
            document.getElementById('peopleCount').textContent = response.count;

            if (response.count === 0) {
              document.getElementById('emptyState').style.display = 'block';
              document.getElementById('peopleContainer').innerHTML = '';
            } else {
              document.getElementById('emptyState').style.display = 'none';
            }
          }
        } catch (error) {
          console.error('Error loading people:', error);
          document.getElementById('peopleContainer').innerHTML = '<div class="empty-state">Error loading people. Please try again.</div>';
        }
      }

      function displayPeople(people) {
        const container = document.getElementById('peopleContainer');
        container.innerHTML = '';

        people.forEach(person => {
          const card = document.createElement('div');
          card.className = 'case-card';
          card.style.cursor = 'pointer';

          const dateStr = new Date(person.created_at).toLocaleDateString('en-GB');

          card.innerHTML = `
            <div style="display: flex; flex-direction: column; height: 100%;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0;">${escapeHtml(person.full_name)}</h3>
                <div class="case-date" style="background: var(--background); padding: 2px 8px; border-radius: 4px;">${dateStr}</div>
              </div>
              
              <div class="case-description">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <span style="font-size: 0.875rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                    ğŸ“ ${escapeHtml(person.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}
                  </span>
                  <span style="font-size: 0.875rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                    ğŸ“ ${escapeHtml(person.phone || 'ØºÙŠØ± Ù…Ù‚Ø¯Ù…')}
                  </span>
                  <span style="font-size: 0.875rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ${person.number_of_people} Ø£ÙØ±Ø§Ø¯
                  </span>
                </div>
                ${person.notes ? `<p style="margin-top: 1rem; font-size: 0.8125rem; color: var(--text-muted); font-style: italic; border-right: 2px solid var(--border); padding-right: 8px;">${escapeHtml(person.notes)}</p>` : ''}
              </div>
              
              <div style="margin-top: auto; padding-top: 1rem; display: flex; justify-content: flex-end;">
                <span class="badge" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
              </div>
            </div>
          `;

          card.addEventListener('click', () => showPersonDetails(person));
          container.appendChild(card);
        });
      }

      function openPersonModal() {
        isEditMode = false;
        currentPersonId = null;
        document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯';
        clearPersonForm();
        document.getElementById('personModal').classList.add('active');
        document.getElementById('personMessage').style.display = 'none';
      }

      function closePersonModal() {
        document.getElementById('personModal').classList.remove('active');
        clearPersonForm();
        isEditMode = false;
        currentPersonId = null;
      }

      function clearPersonForm() {
        document.getElementById('personName').value = '';
        document.getElementById('personPhone').value = '';
        document.getElementById('personCity').value = '';
        document.getElementById('personNumberOfPeople').value = '1';
        document.getElementById('personNotes').value = '';
      }

      async function submitPerson() {
        const name = document.getElementById('personName').value.trim();
        const phone = document.getElementById('personPhone').value.trim();
        const city = document.getElementById('personCity').value.trim();
        const numberOfPeople = parseInt(document.getElementById('personNumberOfPeople').value) || 1;
        const messageEl = document.getElementById('personMessage');

        if (!name) {
          showMessage(messageEl, 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø·Ù„ÙˆØ¨', 'error');
          return;
        }

        if (!city) {
          showMessage(messageEl, 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
          return;
        }

        try {
          messageEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
          messageEl.className = 'message info';
          messageEl.style.display = 'block';

          if (isEditMode) {
            await peopleAPI.update(currentPersonId, {
              full_name: name,
              phone: phone || null,
              city,
              number_of_people: numberOfPeople
            });
            messageEl.textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø®Øµ Ø¨Ù†Ø¬Ø§Ø­!';
          } else {
            await peopleAPI.create(name, phone || null, city, numberOfPeople);
            messageEl.textContent = 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø®Øµ Ø¨Ù†Ø¬Ø§Ø­!';
          }

          messageEl.className = 'message success';

          setTimeout(() => {
            closePersonModal();
            loadPeople();
          }, 1000);
        } catch (error) {
          showMessage(messageEl, error.message, 'error');
        }
      }

      async function showPersonDetails(person) {
        currentPersonId = person.id;
        const content = document.getElementById('personDetailsContent');

        const dateStr = new Date(person.created_at).toLocaleDateString('en-GB');

        content.innerHTML = `
        <div style="padding: 20px 0;">
          <h3>${escapeHtml(person.full_name)}</h3>
          <div style="margin: 15px 0;">
            <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${escapeHtml(person.phone || 'ØºÙŠØ± Ù…Ù‚Ø¯Ù…')}</p>
            <p><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${escapeHtml(person.city)}</p>
            <p><strong>Ø­Ø¬Ù… Ø§Ù„Ø£Ø³Ø±Ø©:</strong> ${person.number_of_people} Ø£Ø´Ø®Ø§Øµ</p>
            <p><strong>ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</strong> ${dateStr}</p>
            ${person.notes ? `<p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${escapeHtml(person.notes)}</p>` : ''}
          </div>
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;" id="personDetailsActions">
          </div>
        </div>
      `;

        // Create update button programmatically to avoid inline JSON issues
        const updateBtn = document.createElement('button');
        updateBtn.className = 'btn-secondary';
        updateBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
        updateBtn.onclick = () => {
          populatePersonForm(person);
        };
        
        document.getElementById('personDetailsActions').appendChild(updateBtn);

        document.getElementById('personDetailsModal').classList.add('active');
      }

      function closeDetailsModal() {
        document.getElementById('personDetailsModal').classList.remove('active');
        currentPersonId = null;
      }

      function populatePersonForm(person) {
        isEditMode = true;
        currentPersonId = person.id;
        document.getElementById('personName').value = person.full_name;
        document.getElementById('personPhone').value = person.phone || '';
        document.getElementById('personCity').value = person.city;
        document.getElementById('personNumberOfPeople').value = person.number_of_people;
        document.getElementById('personNotes').value = person.notes || '';
        document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø®Øµ';
        document.getElementById('personModal').classList.add('active');
        document.getElementById('personDetailsModal').classList.remove('active');
        document.getElementById('personMessage').style.display = 'none';
      }

      async function confirmDeletePerson() {
        if (!currentPersonId) return;

        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
          try {
            await peopleAPI.delete(currentPersonId);
            closeDetailsModal();
            loadPeople();
          } catch (error) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ø®Øµ: ' + error.message);
          }
        }
      }

      function handleLogout() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
          logout();
        }
      }

      function showMessage(element, message, type) {
        element.textContent = message;
        element.className = `message ${type}`;
        element.style.display = 'block';
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Make functions available globally for inline onclick
      window.populatePersonForm = populatePersonForm;
    </script>
</body>

</html>